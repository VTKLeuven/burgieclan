{% extends '@EasyAdmin/page/content.html.twig' %}

{% block page_title %}Edit Document Metadata - Bulk Upload{% endblock %}

{% block content_title %}
<twig:ea:Icon name="fa fa-pen-to-square" class="me-1" />
Review and Edit Document Metadata
{% endblock %}

{% block configured_head_contents %}
{{ parent() }}
<style>
    .bulk-edit-panel {
        display: none;
    }

    .bulk-edit-panel.active {
        display: block;
    }

    .bulk-edit-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .checkbox-cell {
        width: 40px;
        text-align: center;
    }

    /* Set maximum widths for table columns to enable proper truncation */
    .table td:nth-child(2) {
        max-width: 150px;
    }

    .table td:nth-child(3) {
        max-width: 180px;
    }

    .table td:nth-child(4),
    .table td:nth-child(5),
    .table td:nth-child(6) {
        max-width: 150px;
    }

    .table td:nth-child(7) {
        max-width: 250px;
    }

    .table .form-control-sm,
    .table .form-select-sm {
        max-width: 100%;
    }
</style>
{% endblock %}

{% block main %}
    <twig:ea:Alert variant="info">
        <h5 class="alert-heading">
            <twig:ea:Icon name="fa fa-circle-info" class="me-1" />
            Instructions
        </h5>
        <ul class="mb-0">
            <li>Review the document metadata below</li>
            <li>Edit individual fields directly in the table</li>
            <li>Select multiple documents and use "Bulk Edit" to change course, category, year, or tags for all selected</li>
            <li>Click "Create All Documents" when ready to finalize the upload</li>
        </ul>
    </twig:ea:Alert>

    <div class="bulk-edit-panel card shadow-sm mb-3" id="bulkEditPanel">
        <div class="card-body">
            <h5 class="card-title">
                <twig:ea:Icon name="fa fa-pen-to-square" class="me-2" />
                Bulk Edit Selected Documents
                (<span id="selectedCount" class="fw-bold text-primary">0</span> selected)
            </h5>
            <form method="POST" action="{{ path('admin_bulk_upload_update_metadata') }}" id="bulkEditForm" class="ea-form">
                <div class="bulk-edit-form">
                    <div class="mb-3">
                        <label for="bulk_course" class="form-label">
                            <twig:ea:Icon name="fa fa-book" class="me-1" />
                            Course
                        </label>
                        <select name="bulk_course" id="bulk_course" class="form-select">
                            <option value="">-- No change --</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="bulk_category" class="form-label">
                            <twig:ea:Icon name="fa fa-folder" class="me-1" />
                            Category
                        </label>
                        <select name="bulk_category" id="bulk_category" class="form-select">
                            <option value="">-- No change --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.nameNl }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="bulk_year" class="form-label">
                            <twig:ea:Icon name="fa fa-calendar-days" class="me-1" />
                            Year
                        </label>
                        <select name="bulk_year" id="bulk_year" class="form-select">
                            <option value="">-- No change --</option>
                            {% for year, yearLabel in yearChoices %}
                            <option value="{{ year }}">{{ yearLabel }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="bulk_tags" class="form-label">
                            <twig:ea:Icon name="fa fa-tags" class="me-1" />
                            Tags
                        </label>
                        <select name="bulk_tags[]" id="bulk_tags" multiple size="3" class="form-select">
                            {% for tag in tags %}
                            <option value="{{ tag.id }}">{{ tag.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>

                    <div class="d-flex align-items-end">
                        <twig:ea:Button type="submit" variant="primary" icon="fa fa-check">
                            Apply to Selected
                        </twig:ea:Button>
                    </div>
                </div>
                <div id="selectedInputs"></div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="POST" action="{{ path('admin_bulk_upload_update_metadata') }}" id="mainForm" class="ea-form">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-file-lines" class="me-1" />
                                    Filename
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-signature" class="me-1" />
                                    Document Name
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-book" class="me-1" />
                                    Course
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-folder-open" class="me-1" />
                                    Category
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-calendar-days" class="me-1" />
                                    Year
                                </th>
                                <th>
                                    <twig:ea:Icon name="fa fa-tags" class="me-1" />
                                    Tags
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for index, doc in documents %}
                            <tr>
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="doc-select form-check-input" name="selected[]"
                                        value="{{ index }}">
                                </td>
                                <td>
                                    <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ doc.originalName }}">
                                        {{ doc.originalName }}
                                    </span>
                                </td>
                                <td>
                                    <input type="text" name="name[{{ index }}]" value="{{ doc.name }}"
                                        class="form-control form-control-sm">
                                </td>
                                <td>
                                    <select name="course[{{ index }}]" class="form-select form-select-sm"
                                        title="{{ doc.courseEntity ? doc.courseEntity.name ~ ' (' ~ doc.courseEntity.code ~ ')' : 'Select course' }}">
                                        {% for course in courses %}
                                        <option value="{{ course.id }}" {% if doc.courseEntity and
                                            doc.courseEntity.id==course.id %}selected{% endif %}
                                            title="{{ course.name }} ({{ course.code }})">
                                            {{ course.name }} ({{ course.code }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="category[{{ index }}]" class="form-select form-select-sm"
                                        title="{{ doc.categoryEntity ? doc.categoryEntity.nameNl : 'Select category' }}">
                                        {% for category in categories %}
                                        <option value="{{ category.id }}" {% if doc.categoryEntity and
                                            doc.categoryEntity.id==category.id %}selected{% endif %}
                                            title="{{ category.nameNl }}">
                                            {{ category.nameNl }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="year[{{ index }}]" class="form-select form-select-sm" title="{{ doc.year }}">
                                        {% for year, yearLabel in yearChoices %}
                                        <option value="{{ year }}" {% if doc.year==year %}selected{% endif %}
                                            title="{{ yearLabel }}">
                                            {{ yearLabel }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <select name="tags[{{ index }}][]" multiple size="2" class="form-select form-select-sm"
                                        title="{% if doc.tagEntities %}{% for tag in doc.tagEntities %}{{ tag.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}Select tags{% endif %}">
                                        {% for tag in tags %}
                                        <option value="{{ tag.id }}" {% if doc.tagEntities and tag in doc.tagEntities
                                            %}selected{% endif %} title="{{ tag.name }}">
                                            {{ tag.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex gap-2 mt-3 justify-content-end">
                    <twig:ea:Button htmlElement="a" href="{{ path('admin_bulk_upload_create_all') }}" variant="success"
                        icon="fa fa-circle-check"
                        htmlAttributes="{{ {onclick: 'return confirm(\'Create ' ~ documents|length ~ ' document(s)?\')' } }}">
                        Create All Documents ({{ documents|length }})
                    </twig:ea:Button>

                    <twig:ea:Button htmlElement="a" href="{{ path('admin_bulk_upload_index') }}" variant="default"
                        icon="fa fa-xmark"
                        htmlAttributes="{{ {onclick: 'return confirm(\'Are you sure you want to cancel and start over?\')' } }}">
                        Cancel & Start Over
                    </twig:ea:Button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block configured_body_contents %}
{{ parent() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.doc-select');
        const bulkEditPanel = document.getElementById('bulkEditPanel');
        const selectedCount = document.getElementById('selectedCount');
        const selectedInputs = document.getElementById('selectedInputs');
        const bulkEditForm = document.getElementById('bulkEditForm');

        function updateBulkEditPanel() {
            const checked = document.querySelectorAll('.doc-select:checked');
            selectedCount.textContent = checked.length;

            if (checked.length > 0) {
                bulkEditPanel.classList.add('active');

                // Update hidden inputs for selected items
                selectedInputs.innerHTML = '';
                checked.forEach(checkbox => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'selected[]';
                    input.value = checkbox.value;
                    selectedInputs.appendChild(input);
                });
            } else {
                bulkEditPanel.classList.remove('active');
            }
        }

        selectAll.addEventListener('change', function () {
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateBulkEditPanel();
        });

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                updateBulkEditPanel();

                // Update "select all" checkbox state
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            });
        });

        // Initial state
        updateBulkEditPanel();
    });
</script>
{% endblock %}