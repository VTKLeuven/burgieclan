services:
  nginx:
    # Official nginx image
    image: nginx:alpine
    container_name: burgieclan-nginx

    # Restart policy
    restart: unless-stopped

    # Port mapping - nginx is the entry point
    ports:
      - "8080:80"
      - "4000:443"

    # Environment variables for nginx config
    environment:
      SERVER_NAME: ${SERVER_NAME:-_}
      FRONTEND_HOST: ${FRONTEND_HOST:-host.docker.internal}
      FRONTEND_PORT: ${FRONTEND_PORT:-3000}

    # Volume mounts
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ${SSL_CERT_DIR:-./ssl}:/etc/nginx/ssl:ro

    # Depends on backend service
    depends_on:
      - backend

    # Use host network mode if frontend is running on host
    # Comment this out if frontend is also containerized
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Logging configuration
    # logging:
    #   driver: "json-file"
    #   options:
    #     max-size: "10m"
    #     max-file: "3"

  backend:
    # Image from GitHub Container Registry
    image: ghcr.io/${GITHUB_REPOSITORY}/backend:test
    container_name: burgieclan-backend

    # Restart policy - always restart unless manually stopped
    restart: unless-stopped

    # Port mapping - only expose internally to nginx
    expose:
      - "8080"

    # Environment variables
    environment:
      # PHP-FPM worker processes
      # Calculate: (Available RAM - System RAM) / 256MB per process
      MAX_REQUESTS: ${MAX_REQUESTS:-8}

      # Symfony environment
      APP_ENV: ${APP_ENV:-prod}
      APP_DEBUG: ${APP_DEBUG:-0}
      APP_SECRET: ${APP_SECRET:?APP_SECRET is required}

      # Database configuration
      DATABASE_URL: ${DATABASE_URL:?DATABASE_URL is required}

      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:?JWT_PUBLIC_KEY is required}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE:-}

      # CORS configuration (if needed)
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN:-^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$$}

      # Sentry error tracking
      SENTRY_DSN: ${SENTRY_DSN:-}

    # Volume mounts
    volumes:
      # Data directory - where uploaded files and SQLite database are stored
      # This must be an absolute path on the host
      - ${DATA_DIR:?DATA_DIR is required}:/app/data
       # JWT keys (read-only mount for security)
      - ${JWT_DIR:?JWT_DIR is required}:/app/config/jwt
      # Var directory for cache and logs
      # Using named volume for better performance
      - backend_var:/app/var

    # Logging configuration - prevent logs from filling disk
    # logging:
    #   driver: "json-file"
    #   options:
    #     max-size: "10m"
    #     max-file: "3"
    # Resource limits (optional - adjust based on your server)
    # Uncomment to set limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '1'
    #       memory: 1G

volumes:
  backend_var:
    driver: local
