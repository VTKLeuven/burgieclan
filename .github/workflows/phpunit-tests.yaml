name: PHPUnit Tests

on:
  push:
    branches:
      - release/**
  pull_request:
    branches:
      - "**"

jobs:
  php-unit:
    runs-on: ubuntu-latest # The job runs on the latest version of Ubuntu

    steps:
      - name: Checkout code
        uses: actions/checkout@v2 # Checks out the repository code

      - name: Set up PHP
        uses: shivammathur/setup-php@v2 # Sets up the specified PHP version
        with:
          php-version: "8.0" # Specifies PHP version 8.0

      - name: Install dependencies
        run: cd ${{ secrets.WORK_DIR_BACKEND }} && composer install --no-dev --optimize-autoloader # Installs PHP dependencies without dev dependencies

      - name: Backend - Update migrations
        run: cd ${{ secrets.WORK_DIR_BACKEND }} && bin/console doctrine:migrations:migrate

      - name: Run PHPUnit tests
        run: ${{ secrets.WORK_DIR_BACKEND }}/vendor/bin/phpunit ${{ secrets.WORK_DIR_BACKEND }}/tests # Runs PHPUnit tests located in the backend/tests directory

      - name: Block merge if tests fail
        if: failure() # This step runs only if the previous steps failed
        run: exit 1 # Exits with a non-zero status to block the merge if tests fail
